name: Yu Notice Bot Scraper

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  
  workflow_dispatch:  # Allow manual trigger
  
  push:
    branches:
      - main
    paths:
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/scraper.yml'

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          TELEGRAM_TOPIC_MAP: ${{ secrets.TELEGRAM_TOPIC_MAP || '{}' }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || 'gemini-2.5-flash' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_WEBHOOK_MAP: ${{ secrets.DISCORD_WEBHOOK_MAP || '{}' }}
          DISCORD_CHANNEL_MAP: ${{ secrets.DISCORD_CHANNEL_MAP || '{}' }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          CANVAS_TOKEN: ${{ secrets.CANVAS_TOKEN }}
          LOG_LEVEL: INFO
        run: |
          python main.py --once
      
      - name: Extract Error Logs
        if: failure()
        id: extract_logs
        run: |
          if [ -f bot.log ]; then
            echo "LOG_SNIPPET<<EOF" >> $GITHUB_ENV
            tail -n 20 bot.log | cut -c 1-1000 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "LOG_SNIPPET=No log file found." >> $GITHUB_ENV
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs
          path: bot.log
          retention-days: 7
      
      - name: Notify on failure
        if: failure()
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_WEBHOOK_MAP: ${{ secrets.DISCORD_WEBHOOK_MAP || '{}' }}
          DISCORD_CHANNEL_MAP: ${{ secrets.DISCORD_CHANNEL_MAP || '{}' }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          TELEGRAM_TOPIC_MAP: ${{ secrets.TELEGRAM_TOPIC_MAP || '{}' }}
          LOG_SNIPPET: ${{ env.LOG_SNIPPET }}
        run: |
          python scripts/notify_failure.py
