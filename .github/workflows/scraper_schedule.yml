name: YU Crawler Bot (Fast Cycle)

on:
  schedule:
    - cron: '*/30 * * * *' # Every 30 minutes
  workflow_dispatch:

permissions:
  packages: read

jobs:
  scrape:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site: [yu_news, cse_notice, bachelor_guide, dormitory_notice, eoullim_career, eoullim_external, eoullim_study, calendar, dormitory_menu]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set lower case image name
        run: |
          echo "IMAGE_NAME_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Run Scraper Container
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          TELEGRAM_TOPIC_MAP: ${{ secrets.TELEGRAM_TOPIC_MAP || '{}' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_WEBHOOK_MAP: ${{ secrets.DISCORD_WEBHOOK_MAP || '{}' }}
          DISCORD_CHANNEL_MAP: ${{ secrets.DISCORD_CHANNEL_MAP || '{}' }}
          DISCORD_TAG_MAP: ${{ secrets.DISCORD_TAG_MAP || '{}' }}
          CANVAS_TOKEN: ${{ secrets.CANVAS_TOKEN }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || 'gemini-2.5-flash' }}
          IMAGE_NAME: ${{ env.IMAGE_NAME_LOWER }}
        run: |
          docker run --rm \
          -e SUPABASE_URL="$SUPABASE_URL" \
          -e SUPABASE_KEY="$SUPABASE_KEY" \
          -e GEMINI_API_KEY="$GEMINI_API_KEY" \
          -e DISCORD_BOT_TOKEN="$DISCORD_BOT_TOKEN" \
          -e TELEGRAM_TOKEN="$TELEGRAM_TOKEN" \
          -e CHAT_ID="$CHAT_ID" \
          -e TELEGRAM_TOPIC_MAP="$TELEGRAM_TOPIC_MAP" \
          -e DISCORD_WEBHOOK_URL="$DISCORD_WEBHOOK_URL" \
          -e DISCORD_WEBHOOK_MAP="$DISCORD_WEBHOOK_MAP" \
          -e DISCORD_CHANNEL_MAP="$DISCORD_CHANNEL_MAP" \
          -e DISCORD_TAG_MAP="$DISCORD_TAG_MAP" \
          -e CANVAS_TOKEN="$CANVAS_TOKEN" \
          -e GEMINI_MODEL="$GEMINI_MODEL" \
          -v ${{ github.workspace }}:/app \
          ghcr.io/$IMAGE_NAME:latest \
          python main.py --target ${{ matrix.site }} --once

      - name: Extract Error Logs
        if: failure()
        id: extract_logs
        run: |
          if [ -f bot.log ]; then
            echo "LOG_SNIPPET<<EOF" >> $GITHUB_ENV
            tail -n 20 bot.log | cut -c 1-1000 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "LOG_SNIPPET=No log file found." >> $GITHUB_ENV
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ matrix.site }}
          path: bot.log
          retention-days: 7

      - name: Notify on failure
        if: failure()
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_WEBHOOK_MAP: ${{ secrets.DISCORD_WEBHOOK_MAP || '{}' }}
          DISCORD_CHANNEL_MAP: ${{ secrets.DISCORD_CHANNEL_MAP || '{}' }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          TELEGRAM_TOPIC_MAP: ${{ secrets.TELEGRAM_TOPIC_MAP || '{}' }}
          LOG_SNIPPET: ${{ env.LOG_SNIPPET }}
        run: |
          pip install aiohttp
          python scripts/notify_failure.py
